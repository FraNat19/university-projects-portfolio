% Load the data from Excel 
data = readtable('CRIMEd.xlsx');

% Identify numeric columns 
numeric_vars = varfun(@isnumeric, data, 'OutputFormat', 'uniform'); 

% Extract numerical data as a matrix 
numerical_data = data{:, numeric_vars}; 

numerical_data = data{:, numeric_vars};  % Original line
numerical_data(:, 1:2) = [];  % Remove the first two columns

% Standardize the numerical data 
standardized_data = zscore(numerical_data); 

% Compute the correlation matrix of the standardized data 
correlation_matrix = corr(standardized_data); 

% Identify and remove highly collinear variables (correlation threshold: 0.99) 
threshold = 0.99; 
redundant_vars = any(abs(correlation_matrix - eye(size(correlation_matrix))) > threshold, 1); 

% Remove redundant variables from the dataset 
cleaned_data = standardized_data(:, ~redundant_vars); 

% Recompute the correlation matrix with cleaned data 
correlation_matrix = corr(cleaned_data); 

S=1/1994*standardized_data'*standardized_data;
SA=abs(S);
heatmap(SA);

% Eigenvalues from the covariance matrix
[coeff, ~, latent] = pca(standardized_data);

% Plot Scree plot
plot(1:length(latent), latent, '-o');
title('Scree Plot');
xlabel('Component Number');
ylabel('Eigenvalue');

% Compute eigenvalues of the new correlation matrix 
eigenvalues = eig(correlation_matrix); 

% Sort eigenvalues in descending order for clarity 
eigenvalues = sort(eigenvalues, 'descend'); 

% Display eigenvalues 
disp('Eigenvalues of the correlation matrix:'); 
disp(eigenvalues); 

% Determine the number of factors to retain (Kaiser’s criterion: eigenvalues > 1) 
num_factors = sum(eigenvalues > 1); 
disp(['Number of factors to retain: ', num2str(num_factors)]); 

% Perform factor analysis with the number of factors determined 
[loadings, psi, stats] = factoran(cleaned_data, num_factors); 

% Check if the `loadings` matrix is valid for the DFA function 
disp('Loadings matrix:'); 
disp(loadings); 

% Perform Disjoint Factor Analysis (DFA)
% Ensure that DFA.m handles inputs correctly 
disjoint_factors = DFA(cleaned_data, num_factors);

% Calculate factor correlation matrix
factorCorrMatrix = corr(disjoint_factors);

% Plot factor correlation matrix for visualization
imagesc(factorCorrMatrix);
colormap(flipud(hot));
colorbar;
title('Factor Correlation Matrix');

%Apply a 2nd order
disjoint_factors = DFA1(cleaned_data, num_factors);

% Calculate factor correlation matrix
factorCorrMatrix = corr(Ydfa);


% Plot heatmap of factor correlation matrix
figure;
heatmap(factorCorrMatrix, 'Colormap', parula, 'ColorbarVisible', 'on');
title('Factor Correlation Matrix');
xlabel('Factors');
ylabel('Factors');


[Vdfa, Adfa, Psifa, Ydfa, fdfa, indfa, BIC, AIC] = DFA1(cleaned_data, num_factors);
[Vdfa2,Adfa2, Psidfa2, Ydfa2, fdfa2, indfa2, BIC2, AIC2] = DFA1(C, num_factors);
ì
% Visualizzare la heatmap dei loadings
figure;
h = heatmap(Adfa);

% Configurare la colormap
h.Colormap = parula;

% Aggiungere titoli e etichette
title('Heatmap of Factor Loadings');
xlabel('Factors');
ylabel('Variables');

% (Opzionale) Impostare limiti per la scala di colore
h.ColorLimits = [-1, 1]; % Se i loadings sono tra -1 e 1





total_variance = sum(var(cleaned_data));

residual_variance = sum(var(Ydfa)) / total_variance;

R_squared = residual_variance ;

disp(['explained variance for 5 factors: ', num2str(R_squared)]);



% Number of variables (items) in the cleaned dataset
k = size(cleaned_data, 2);

% Compute the sum of the variables (total score for each observation)
total_score = sum(cleaned_data, 2);

% Variance of the total score (variance of summed scores across observations)
total_score_variance = var(total_score);

% Compute the sum of individual item variances
item_variances = sum(var(cleaned_data, 0, 1)); % Use the unbiased variance estimator

% Compute Cronbach's alpha
cronbach_alpha = (k / (k - 1)) * (1 - (item_variances / total_score_variance));

% Display the result
disp(['Cronbach''s Alpha: ', num2str(cronbach_alpha)]);


loadings=Ydfa;
% Calculate factor scores
factorScores = cleaned_data * loadings;
% Create a composite score as a weighted sum of factors
weights = mean(loadings, 1); % Adjust weights as necessary
compositeIndex = factorScores * weights';

% Normalize composite index to [0, 1] range
compositeIndex = (compositeIndex - min(compositeIndex)) / (max(compositeIndex) - min(compositeIndex));

% Add composite index to the original table and save
data.CompositeIndex = compositeIndex;
writetable(data, 'CompositeIndexResults.xlsx');

data = readtable('CompositeIndexResults.xlsx');

selectedData = data(:, {'state', 'communityname', 'CompositeIndex'});

selectedData = sortrows(selectedData, 'CompositeIndex', 'descend');

% Salva la tabella ordinata in un nuovo file Excel
writetable(selectedData, 'SortedCompositeIndex.xlsx');


% Data for community names, composite index, latitude, and longitude
% Define the data
communityname = {'Newarkcity', 'Camdencity', 'Miamicity', 'Comptoncity', 'Cudahycity', 'Bellcity', 'HuntingtonParkcity', ...
                 'BellGardenscity', 'Lynwoodcity', 'Hartfordtown', 'Inglewoodcity', 'Maywoodcity', 'EastPaloAltocity', ...
                 'AsburyParkcity', 'Patersoncity', 'Passaiccity', 'NationalCitycity', 'Corcorancity', 'EastOrangecity', ...
                 'ElMontecity', 'SouthGatecity', 'Oaklandcity', 'Paramountcity', 'Prichardcity', 'AtlanticCitycity', ...
                 'SanPablocity', 'Tuskegeecity', 'Homesteadcity', 'Delanocity', 'CityofOrangetownship', 'Rosemeadcity', ...
                 'Lawrencecity', 'Newburghcity', 'JerseyCitycity', 'NewBrunswickcity', 'FortPiercecity', 'NewOrleanscity', ...
                 'CollegeParkcity', 'Irvingtontownship', 'LosAngelescity', 'UnionCitycity', 'Washingtoncity', 'Sunnysidecity', ...
                 'Hawthornecity', 'Chestercity', 'EastChicagocity', 'Baltimorecity', 'Garycity', 'Augustacity', 'Atlantacity', ...
                 'Greenwoodcity', 'Trentoncity', 'SanFernandocity', 'Pascocity', 'Commercecity', 'Clevelandcity', 'MiamiBeachcity', ...
                 'Maderacity', 'EaglePasscity', 'Monroecity', 'NewYorkcity', 'SouthElMontecity', 'NewHaventown', 'Palatkacity', ...
                 'ForrestCitycity', 'Harrisburgcity', 'SantaAnacity', 'BaldwinParkcity', 'Natchitochescity', 'Sangercity', ...
                 'Dinubacity', 'SanBernardinocity', 'Selmacity', 'Alhambracity', 'Bridgeporttown', 'Indiocity', 'Pomonacity', ...
                 'Greenvillecity', 'Douglascity', 'Americuscity', 'Watsonvillecity', 'Reedleycity', 'Pharrcity', 'Selmacity', ...
                 'Avondalecity', 'WestNewYorktown', 'ElCentrocity', 'Bostoncity', 'Richmondcity', 'LauderdaleLakescity', ...
                 'Petersburgcity', 'Montebellocity', 'Laurinburgcity', 'Brownsvillecity', 'Mercedescity', 'Plainfieldcity', ...
                 'Vicksburgcity', 'PerthAmboycity','Wakefieldtown', 'RanchoPalosVerdescity', 'Tenaflyborough', 'Carmelcity', 'Perrysburgcity', ...
                 'Dyertown', 'Yorktownship', 'NetherProvidencetownship', 'Marshfieldtown', 'WestGoshentownship', ...
                 'Moorestowntownship', 'Coventrytown', 'Somersettown', 'Sheltontown', 'Middletowntownship', ...
                 'NorthAndovertown', 'Saugustown', 'Farmingtontown', 'Manheimtownship', 'NorthSmithfieldtown', ...
                 'Wethersfieldtown', 'Muhlenbergtownship', 'Totowaborough', 'Danverstown', 'Raritantownship', ...
                 'Swampscotttown', 'CedarGrovetownship', 'Centertownship', 'BrownDeervillage', 'Bexleycity', ...
                 'Kellercity', 'Paramusborough', 'SpringGardentownship', 'Eastontown', 'WestMilfordtownship', ...
                 'Cinnaminsontownship', 'Ryecity', 'Brookfieldtown', 'Cranberrytownship', 'Delhitownship', ...
                 'Marlborotownship', 'Ballwincity', 'Mentorcity', 'Westlakecity', 'EastHamptontown', ...
                 'VestaviaHillscity', 'Bethlehemtownship', 'Springtownship', 'ScotchPlainstownship', 'Montgomerytownship', ...
                 'Worthingtoncity', 'Bartletttown', 'LowerSalfordtownship', 'Scituatetown', 'Caledoniatown', ...
                 'Vernontownship', 'Ridgewoodvillage', 'Randolphtownship', 'Walltownship', 'Hampdentownship', ...
                 'Beavercreekcity', 'Southingtontown', 'Springfieldtownship', 'NorthHuntingdontownship', ...
                 'EastLongmeadowtown', 'Jeffersontownship', 'EastNorritontownship', 'Astontownship', 'CottageGrovecity', ...
                 'Cheshiretown', 'Germantownvillage', 'Haddonfieldborough', 'Pembroketown', 'SouthWhitehalltownship', ...
                 'Miltontown', 'Ramseyborough', 'Rockawaytownship', 'Cranfordtownship', 'BethelParkborough', ...
                 'WhitefishBayvillage', 'Shalertownship', 'Glastonburytown', 'Walpoletown', 'Chelmsfordtown', ...
                 'Haverfordtownship', 'Warwicktownship', 'Westporttown', 'Munstertown', 'Veronatownship', ...
                 'Strongsvillecity', 'Newtowntown', 'Tredyffrintownship', 'Barringtontown', 'Crestwoodcity', ...
                 'Polandtownship', 'Penntownship', 'Northboroughtown', 'Waynetownship', 'Hillsboroughtown', ...
                 'UpperGwyneddtownship', 'NewCanaantown', 'LaPortecity', 'Mesquitecity', 'SouthKingstowntown', 'Berwickborough', ...
                 'Concordcity', 'DiamondBarcity', 'Cypresscity', 'Norwalkcity', 'Brunswicktown', 'FarmersBranchcity', 'Burlingamecity', ...
                 'Marinettecity', 'Homewoodcity', 'Pinolecity', 'Atholtown', 'Berkeleytownship', 'Burkburnettcity', 'Lovelandcity', 'Springdalecity', ...
                 'Ashlandcity', 'Martinezcity', 'Auburncity', 'Milwaukiecity', 'Ridgelandcity', 'Canandaiguacity', 'LaVernecity', 'Ocoeecity', 'Valparaisocity', ...
                 'Northglenncity', 'Millbraecity', 'Littletoncity', 'Vidorcity', 'Pacificacity', 'Scottsborocity', 'Wausaucity', 'Gillettecity', 'LaMiradacity', ...
                 'Westminstercity', 'SomersPointcity', 'Irvinecity', 'ChippewaFallscity', 'Augustacity', 'OakRidgecity', 'Pottsvillecity', 'Aberdeencity', 'PoncaCitycity', ...
                 'GlensFallscity', 'Moorparkcity', 'RichmondHeightscity', 'Scottsdalecity', 'Jamestowncity', 'Nashuacity', 'Kirklandcity', 'Bedfordcity', 'Middletowntown', ...
                 'Naplescity', 'Lebanoncity', 'Tigardcity', 'Martinsvillecity', 'Lafayettecity', 'NorthPlainfieldborough', 'Lebanoncity', 'WisconsinRapidscity', ...
                 'Bartlesvillecity', 'Webstertown', 'OceanSpringscity', 'NorthBrunswicktownship', 'Nanticokecity', 'Wabashcity', 'CedarFallscity', 'Bentoncity', ...
                 'EastProvidencecity', 'Carrolltoncity', 'JeffersonCitycity', 'Teanecktownship', 'BocaRatoncity', 'Camarillocity', 'Speedwaytown', 'Watertowncity', ...
                 'Salemcity', 'Yanktoncity', 'Florencecity', 'GarfieldHeightscity', 'Mitchellcity', 'SanDimascity', 'Tiffincity', 'SandSpringscity', 'Barnstabletown', ...
                 'NewPhiladelphiacity', 'Slidellcity', 'RockSpringscity', 'UpperDarbytownship', 'Derbytown', 'Bristoltown', 'Gallowaytownship', 'Christiansburgtown', ...
                 'Leominstercity', 'Nilescity', 'Prattvillecity', 'Sheboygancity',"Gardnercity", "Angletoncity", "Lindencity", "Athenscity", ...
                "Stauntoncity", "Weatherfordcity", "FortMadisoncity", "Parkersburgcity", "Hopkinscity", "Romecity", "Cheyennecity", "Coronadocity", ...
                "GrandForkscity", "Cerritoscity", "RedondoBeachcity", "Carlisleborough", "Lewistoncity", "Montclairtownship", "Arlingtoncity", "Jaspercity", ...
                "Bangorcity", "Frankfortcity", "Cohoescity", "LakeHavasuCitycity", "Torrancecity", "PortOrangecity", "Burlingtoncity", "Walnutcity", ...
                "Smyrnatown", "PalmDesertcity", "Oswegocity", "Concordcity", "Kingsportcity", "Norcocity", "Enidcity", "Lawrencecity", "Caycecity", ...
                "OceanCitycity", "Shermancity", "Durhamtown", "TempleCitycity", "Willingborotownship", "Hamiltoncity", "Cortlandcity", "Cloviscity", ...
                "Largocity", "SulphurSpringscity", "SouthDaytonacity", "Kentcity", "Tamaraccity", "Pembertontownship", "Medfordcity", "Albanycity", ...
                "Glasgowcity", "MyrtleBeachcity", "McMinnvillecity", "Kennercity", "Gainesvillecity", "RoanokeRapidscity", ...
            "ColoradoSpringsdivision", "Amescity", "FallRivercity", "Winchestercity", "FortWaynecity", "LaMesacity", "NewCastlecity", "Paradisetown", "Englewoodcity", "Lancastercity", "Kennewickcity", "LaCrossecity", "Auburncity", "MountVernoncity", "HarkerHeightscity", "VeroBeachcity", ...
            "Georgetowncity", "Miramarcity", "Florencecity", "Concordcity", "Lynnwoodcity", "Amarillocity", "Portlandcity", "Margatecity",  "Neptunetownship", "McMinnvillecity", "Watervillecity", "Evansvillecity", ...
            "SanJosecity", "Bartowcity", "Turlockcity", "Lexingtoncity", "BayCitycity", "NorthBergentownship", "Phoenixcity", "BoyntonBeachcity", "Salisburycity",  "SouthSaltLakecity", "PortLavacacity", "Cerescity", "Riversidecity", "Pecoscity",  "Kissimmeecity", "NewBritaintown", "Danvillecity", "Englewoodcity", "Flagstaffcity", ...
            "Suffolkcity", "Conroecity", "KansasCitycity", "Bakersfieldcity", "Vancouvercity",  "ApacheJunctioncity", "Tacomacity", "Jenningscity", "Seattlecity", "CorpusChristicity", ...
            "Knoxvillecity", "Pullmancity", "Downeycity", "Corsicanacity", "Visaliacity", "Escondidocity", "Durantcity", "Paducahcity", "Fredericksburgcity", "Lakelandcity", "Arcatacity", "PanamaCitycity", "UnionCitycity", "Opelikacity", "Bryancity", "Harrisontown", "Steubenvillecity", "Muskogeecity", "NewBedfordcity", "McKinneycity", ... 
            "Boonetown", "Columbuscity", "Houmacity", "Altuscity", "WestCovinacity", "Kennettcity", "Lomitacity", "Westminstercity", "Mariettacity", "Dallascity", "SanJacintocity", ...
            "PineBluffcity", "Berkeleycity", "Lauderhillcity", "McAllencity", "Greenwoodcity", "Columbiacity", "Perriscity", "Lancastercity", "Stantoncity", "Newberrytown", ...
            "Wilsoncity", "SanMarcoscity", "Bogalusacity", "Montclaircity", "Jacksoncity", "Norwalkcity", "Seasidecity", "SantaMariacity", "Sacramentocity", "Spartanburgcity", ...
            "Tularecity", "Galvestoncity", "Grenadacity", "Coatesvillecity", "BatonRougecity", "Pasadenacity", "SantaFeSpringscity", "Starkvillecity", "MossPointcity", "Douglascity", ...
            "Brownsvillecity", "PortArthurcity", "Orlandocity", "WestMemphiscity", "Goldsborocity", "Freeportcity", "Shreveportcity", "Rustoncity", "LaGrangecity", "NorthCharlestoncity", ...
            "Syracusecity", "Berkeleycity", "Shelbycity", "Valdostacity", "Carrolltoncity", "LakeWorthcity", "Hobokencity", "Thomasvillecity", "LakeCitycity", "WarrensvilleHeightscity", ...
            "PompanoBeachcity", "Terrellcity", "WestSacramentocity", "NewBerncity", "Meridiancity", "Ithacacity", "DeLandcity", "Clearlakecity", "Gallupcity", "Crowleycity", "Philadelphiacity", ...
            "CentralFallscity", "Brawleycity", "Providencecity", "Elizabethcity", "Salinascity", "Lawndalecity", "Pleasantvillecity", "Bridgetoncity", "NorthMiamicity", "LongBeachcity", ...
            "Donnacity", "EastPointcity", "SanJuancity", "Rochestercity", "Brunswickcity", "FortMyerscity", "SanBenitocity", "LaPuentecity", "Portervillecity", "MontereyParkcity"};

compositeIndex = [1, 0.98760272, 0.972194078, 0.96808294, 0.964471621, 0.949070762, 0.941059532, 0.935308828, 0.932362785, ...
                  0.916047784, 0.907148779, 0.90199618, 0.89559438, 0.876392062, 0.858482714, 0.857053162, 0.850879124, 0.848446838, ...
                  0.839318362, 0.838081453, 0.837916875, 0.835462074, 0.834609089, 0.831865112, 0.82913325, 0.824833686, 0.818809441, ...
                  0.816756934, 0.81182143, 0.8042148, 0.80420966, 0.803812243, 0.80328796, 0.801557032, 0.800562143, 0.798017842, ...
                  0.796641231, 0.796559788, 0.795039688, 0.793361008, 0.79114547, 0.790696463, 0.789423807, 0.786224349, 0.785256996, ...
                  0.783021775, 0.782996081, 0.780569082, 0.780189743, 0.779782919, 0.779722304, 0.777982204, 0.776424731, 0.775366918, ...
                  0.772515906, 0.772276708, 0.768441783, 0.765960697, 0.765274966, 0.763037093, 0.761387685, 0.758240013, 0.757709789, ...
                  0.756262634, 0.756088367, 0.753923884, 0.753296727, 0.749703882, 0.745533258, 0.744893052, 0.744323457, 0.743244318, ...
                  0.742543786, 0.740580202, 0.7393113, 0.736923175, 0.73542782, 0.734309487, 0.730645196, 0.730549123, 0.729228022, ...
                  0.728409035, 0.726908137, 0.726829232, 0.726215518, 0.723794911, 0.721560348, 0.718993775, 0.718847987, 0.718786276, ...
                  0.715817152, 0.713735156, 0.711222093, 0.71035115, 0.709878653, 0.708475256, 0.70813747, 0.707585312,0.142813349, 0.142453667, 0.142104939, 0.141176052, 0.140993181, 0.140482375, 0.140240611, 0.140132571, ...
                  0.140053579, 0.139994616, 0.139521866, 0.139190887, 0.138831548, 0.138560876, 0.138351651, 0.138272568, ...
                  0.137804789, 0.13746875, 0.137394525, 0.137133358, 0.137092821, 0.136848553, 0.136684983, 0.136090788, ...
                  0.135860335, 0.135801349, 0.135592665, 0.134786839, 0.134730501, 0.134707163, 0.133213555, 0.132443795, ...
                  0.132321041, 0.13218992, 0.131455405, 0.131039691, 0.130860242, 0.130083976, 0.129898557, 0.128617848, ...
                  0.128424996, 0.1283021, 0.128154578, 0.127242559, 0.127050034, 0.126937651, 0.12666296, 0.126511239, ...
                  0.12578088, 0.12526205, 0.125097841, 0.124256541, 0.123367287, 0.123051586, 0.122755698, 0.122351096, ...
                  0.122310932, 0.121565501, 0.120693146, 0.120448623, 0.120177007, 0.119870263, 0.11767331, 0.117211916, ...
                  0.116948875, 0.116379935, 0.116222744, 0.116077156, 0.115734663, 0.115313301, 0.115112422, 0.114568507, ...
                  0.114053655, 0.113560514, 0.112718099, 0.112361867, 0.111099762, 0.111065707, 0.110746179, 0.110174355, ...
                  0.109233962, 0.109182215, 0.109147971, 0.108586882, 0.108336815, 0.107660388, 0.10733344, 0.107314117, ...
                  0.106484058, 0.10588569, 0.105210093, 0.104941768, 0.103472996, 0.103119915, 0.10292967, 0.102912526, ...
                  0.102645532, 0.102611722, 0.102217206, 0.101830414, 0.101811147, 0.308156284, 0.307894659, 0.307438144, 0.307418197, ...
                  0.307372207, 0.307083699, 0.306876985, 0.306715008, 0.305660341, 0.305622719, 0.305604971, 0.305573246, 0.305444835, ...
                  0.305361786, 0.305307699, 0.305299122, 0.304961221, 0.304920042, 0.304698408, 0.304628764, 0.304467305, 0.304215124, ...
                  0.304177306, 0.304035436, 0.303818974, 0.303755735, 0.303329382, 0.302467817, 0.302177307, 0.301429937, 0.301428965, ...
                  0.301318665, 0.301313803, 0.301298802, 0.300737542, 0.300703193, 0.299776858, 0.299697405, 0.299510454, 0.299359955, ...
                  0.299299549, 0.298830017, 0.298795169, 0.298355143, 0.298165078, 0.29800996, 0.297513608, 0.296901849, 0.296520208, ...
                  0.296084634, 0.29604317, 0.295750679, 0.295702993, 0.295281385, 0.295029679, 0.294735779, 0.294514181, 0.294349249, ...
                  0.294224221, 0.29419775, 0.294154193, 0.293796614, 0.293420498, 0.293102912, 0.292657095, 0.291884335, 0.291824107, ...
                  0.291779794, 0.291378981, 0.29104145, 0.291029962, 0.29039543, 0.289625015, 0.289552778, 0.289474213, 0.289464441, ...
                  0.289139345, 0.289136858, 0.288545889, 0.28782089, 0.28732509, 0.287262997, 0.287233589, 0.287102353, 0.286712989, ...
                  0.286470676, 0.286227325, 0.286062094, 0.286060003, 0.28602151, 0.285989808, 0.285677106, 0.285531495, 0.285193878, ...
                  0.28481879, 0.284200486, 0.284197978, 0.284151412, 0.283986107, 0.283963737, 0.360517482, 0.360210092, 0.36012727, 0.359478573, 0.359421095, 0.359313152, ...
             0.3587864, 0.358741023, 0.35861557, 0.358519063, 0.358427395, 0.358382425, 0.358283586, 0.358283114, 0.358199611, 0.358022004, 0.357917477, 0.357876633, ...
             0.357047437, 0.357003049, 0.356589821, 0.356376703, 0.355713459, 0.355680523,  0.355338342, 0.355305579, 0.355223415, 0.355155675, 0.354432805, 0.353560255, ...
             0.353444694, 0.353140257, 0.353127545, 0.352829, 0.352686894, 0.352560743,   0.352499654, 0.352373265, 0.417979584, 0.417698325, 0.417544757, 0.417363806, ...
             0.417341904, 0.417043071, 0.416502608, 0.415060574, 0.414280496, 0.41418104, 0.413878501, 0.413668405, 0.413419886, 0.413119295, 0.41287942, 0.412845466,  0.412245187, 0.412119456, 0.411816931, 0.411788059, 0.411101743, 0.411091325, 0.410831434, ...
             0.40961528, 0.409381157, 0.40931864, 0.409091998, 0.408823087, 0.408810577,  0.407621083, 0.406824503, 0.406820857, 0.406757799, 0.406625379, 0.405563462, 0.405438451, 0.405235461, 0.405192835, 0.405171687, 0.405042498, 0.404863506,  0.404714855, 0.404368398, 0.404282549, 0.404039738, 0.40403051, 0.403945167, ...
             0.403738116, 0.403190316, 0.513140149, 0.513003046, 0.512879016, 0.512455311, 0.512376905, 0.512165656, 0.510916105, 0.51078504, 0.510283331, 0.510187724, ...
             0.510072231, 0.509745707, 0.509572793, 0.509564726, 0.508937431, 0.508221269, 0.507736128, 0.507692147, 0.506976491, 0.506459191, 0.506290353, 0.50533393, ...
             0.504927324, 0.504539896, 0.504356206, 0.504290935, 0.504257467, 0.503614193, 0.502820424, 0.502683444, 0.502393213, 0.50218487, 0.502154983, 0.501714308, ...
             0.501497981, 0.501117961, 0.500626939, 0.500382399, 0.500333197, 0.500157113, 0.499695211, 0.49963529, 0.499468151, 0.49877827, 0.498308526, 0.497949096, ...
             0.496812499, 0.496572213, 0.496175387, 0.4959567, 0.49564856, 0.495642649, 0.495586698, 0.495471755, 0.495172445, 0.494836198, 0.494645804, 0.494337473,  0.63400917, 0.633330971, 0.633162426, 0.632908047, 0.632529328, 0.632425675,  0.632205923, 0.632098168, 0.631623736, 0.630395052, 0.62830955, 0.627459064, ...
             0.626585401, 0.626384691, 0.625932288, 0.6255691, 0.623911007, 0.623343527, 0.623339016, 0.623138526, 0.621339715, 0.62083771, 0.620585003, 0.619344764, 0.618719206, 0.617374319, 0.617224347, 0.617090051, 0.61701587, 0.616843789, ...
             0.616661768, 0.615877196, 0.615733653, 0.61570226, 0.615564835, 0.614715701, 0.614452578, 0.613133503, 0.613056986, 0.612970128, 0.612586016, 0.612467198, ...
             0.612306118, 0.612180514, 0.611265062, 0.610322514, 0.609208317, 0.609129783, 0.608452089, 0.607820695, 0.607783152, 0.607283594, 0.606848559, 0.605967292, ...
             0.605361706, 0.604534595, 0.603794931, 0.602052788, 0.601791278, 0.601441173, 0.601413815, 0.601239891, 0.706910213, 0.704679408, 0.703929412, 0.703566736, ...
             0.702376797, 0.701953879, 0.701606642, 0.698170691, 0.696203935, 0.696161611, 0.69602, 0.694919808, 0.694650171, 0.693806272, 0.692868881, 0.692450722, ...
             0.691149552, 0.690121061, 0.689189142, 0.689116433, 0.688062522];

latitude = [40.7357, 39.9259, 25.7617, 33.8958, 33.9606, 33.9775, 33.9817, 33.9653, 33.9303, 41.7658, 33.9617, 33.9867, ...
            37.4688, 40.2204, 40.9168, 40.8568, 32.6781, 36.0980, 40.7673, 34.0686, 33.9547, 37.8044, 33.8895, 30.7388, ...
            39.3643, 37.9622, 32.4316, 25.4687, 35.7688, 40.7700, 34.0806, 38.9717, 41.5034, 40.7178, 40.4862, 27.4467, ...
            29.9511, 38.9807, 40.7223, 34.0522, 40.6976, 38.9072, 46.3235, 33.9164, 39.8496, 41.6391, 39.2904, 41.5934, ...
            33.4735, 33.7490, 34.1954, 40.2171, 34.2819, 46.2396, 39.8083, 41.4993, 25.7907, 36.9613, 28.7091, 32.5093, ...
            40.7128, 34.0517, 41.3083, 29.6486, 35.0081, 40.2737, 33.7455, 34.0853, 31.7607, 36.7086, 36.5430, 34.1083, ...
            32.4074, 34.0953, 41.1792, 33.7206, 34.0551, 34.8526, 31.5085, 32.0724, 36.9102, 36.5961, 26.1948, 36.5700, ...
            33.4356, 40.7879, 32.7920, 42.3601, 37.5407, 26.1665, 37.2279, 34.0165, 34.7740, 25.9017, 26.1498, 40.6337, ...
            32.3526, 40.50, 42.0835, 33.7691, 40.9514, 39.9783, 41.5815, 41.5230, 41.1122, 39.9267, 42.0850, 39.9967, 39.9736,  ...
             41.7010, 40.3783, 41.3160, 40.2975, 42.7021, 42.4668, 41.6726, 40.1340, 41.9490, 41.7040, 40.138, 40.9449, 42.2782, 40.4183, 42.502, 40.2053, 40.1299, 43.1365, 39.9606, 32.9357, ...
  40.9267, 39.946, 40.6725, 41.0849, 40.0135, 41.9754, 43.071, 40.6937, 39.9675, 40.3028, ...
  38.5906, 41.6669, 41.455, 40.9634, 33.4341, 40.638, 40.2624, 40.6518, 40.3953, 40.1013, ...
  35.2044, 40.2164, 42.1861, 44.5385, 41.1261, 40.9755, 40.8831, 40.1447, 40.2334, 39.7094, ...
  41.6004, 40.0187, 40.3407, 42.0511, 40.8785, 40.106, 39.8686, 44.8583, 41.5333, 43.1886, ...
  39.897, 42.0852, 40.6055, 38.7706, 41.0672, 40.9287, 40.655, 40.3367, 43.0806, 40.3344, ...
  41.705, 42.3323, 42.5888, 39.9819, 40.1685, 41.1419, 40.3695, 40.8871, 41.3143, 40.1377, ...
  39.9576, 40.0087, 38.5514, 41.0243, 40.4596, 42.308, 39.9835, 40.5107, 40.1821, 41.1473, 41.6106, ...
              32.7668, 41.4501, 41.0567, 43.2081, 34.0286, 33.8174, 33.9022, 34.0529, 32.9265, 37.5841, 45.0990, 33.4640, ...
              38.0044, 42.5956, 39.9025, 34.0981, 40.3978, 36.1867, 38.4784, 38.0194, 38.8966, 45.4463, 32.4285, 42.8875, ...
              34.1008, 28.5708, 41.4731, 39.8962, 37.6000, 39.6133, 30.1316, 37.6138, 34.6723, 44.9591, 44.2911, 33.9172, ...
              39.8367, 39.3157, 33.6846, 44.9364, 33.4735, 36.0104, 40.6857, 45.4647, 36.7069, 43.3107, 34.2856, 41.5529, ...
              33.4942, 42.0970, 42.7654, 47.6815, 32.8440, 41.5501, 26.1420, 36.2081, 45.4312, 36.6820, 40.4167, 40.6307, ...
              40.3660, 44.3836, 36.7473, 43.2120, 30.4116, 40.4462, 41.2067, 40.7970, 42.5349, 34.5645, 41.8137, 32.9537, 38.5767, ...
              40.8907, 26.3683, 34.2164, 39.7922, 43.9748, 44.9429, 42.8711, 34.1954, 41.4189, 43.7094, 34.1067, 41.1145, 36.1395, ...
              41.7003, 40.4892, 30.2752, 41.5875, 39.9584, 41.3204, 41.6770, 39.4959, 37.1299, 42.5251, 41.1828, 32.4640, 43.7508, 42.3255, 29.1806, 40.6228, 33.9600,  ...
              38.1498, 32.7607, 40.6351, 39.2683, 44.9262, 43.2344, 41.1400, 32.6781, 47.9253, 33.8692, 33.8492, 40.2017,  ...
              46.4131, 40.8584, 32.7357, 38.4025,  44.8012, 38.1975, 42.7833, 34.4839, 33.8358, 29.1386, 44.4759, 34.0206,  ...
              35.9214, 33.7210, 43.4564, 43.2081, 36.5407, 33.9460, 36.3957, 38.9717,  33.9339, 38.3363, 33.6357, 35.9940,  ...
              34.1023, 40.0500, 39.3995, 42.6011,  36.8252, 27.9095, 33.1271, 29.1690,  ...
              41.1510, 26.2176, 39.9893, 42.3265,  42.6526, 37.0034, 33.6891, 35.687, 30.009, 29.652, 36.445, 38.834, 42.035, 41.701, 39.185, ...
            41.079, 32.767, 39.662, 36.058, 39.617, 40.038, 46.211, 43.801, 32.610, 40.913, 31.074, 27.639, 30.633, 25.987, 34.195, 38.005, 47.810, 35.221, 45.505, 26.244, 40.214, 45.204, 44.546, 37.972, 37.338, 27.895, 37.495, 38.041, 43.595, 40.799, 33.448, 26.531, ...
            38.367, 40.705, 28.620, 37.595, 33.980, 31.420, 28.292, 41.661, 36.585, 40.885, 35.198, 36.728, 30.312, 39.099, 35.373, 45.639,  33.415, 47.253, 30.214, 47.606, 27.801, 35.961, 46.730, 33.940, 32.080, 36.330, 33.119, 33.983, 37.083, 38.303, 28.040, 40.866, ...
            30.159, 37.595, 32.640, 30.674, 39.256, 40.367, 35.748, 41.636, 33.197, 38.063, 39.961, 29.596, 34.648, 34.069, 36.233, 33.786, 39.837, 33.953, 32.777, 33.784, 34.229, 37.872, 26.135, 26.203, 33.516, 34.001, 33.783, 34.687, 33.805, 34.278, 35.721, 29.883, ...
            30.866, 34.078, 32.299, 33.902, 36.618, 34.953, 38.582, 34.950, 36.207, 29.301, 33.769, 39.998, 30.452, 29.691, 33.939, 33.450, 30.411, 31.439, 25.902, 29.884, 28.538, 35.150, 35.356, 28.938, 32.525, 32.525, 29.905, 32.877, 43.048, 41.883, 35.290, 30.833, ...
            32.976, 26.618, 40.743, 30.839, 30.181, 41.419, 26.238, 32.749, 38.580, 35.109, 32.364, 42.440, 29.027, 38.958, 35.528, 30.240, 39.953, 41.884, 32.985, 41.824, 40.664, 36.677, 33.889, 39.396, 39.427, 25.891, 33.768, 26.061, 33.680, 18.466, 43.157, 31.149, ...
            26.641, 26.161, 34.021, 36.065, 34.063]; % Latitude values

longitude = [-74.1724, -75.1196, -80.1918, -118.2201, -118.1853, -118.1870, -118.2251, -118.1515, -118.2115, -72.6734, ...
             -118.3531, -118.1853, -122.1411, -74.0121, -74.1718, -74.1285, -117.0992, -119.5601, -5049, -118.0276, ...
             -118.2120, -122.2711, -118.1598, -118.0798, -74.4229, -122.3455, -85.6803, -80.4776, -119.2471, -74.2320, ...
             -118.0728, -95.2353, -74.0104, -74.0431, -74.4518, -80.3256, -90.0715, -76.9378, -74.2318, -118.2437, -74.2632, -77.0369, ...
             -120.0081, -118.3526, -75.3557, -87.4548, -76.6122, -87.3464, -82.0105, -84.3880, -82.1618, -74.7429, -118.4380, ...
             -119.1006, -104.9339, -81.6944, -80.1300, -120.0607, -100.4995, -92.1193, -74.0060, -118.0484, -72.9279, -81.6376, ...
             -90.7865, -76.8844, -117.8677, -117.9609, -93.0863, -119.5560, -119.3876, -117.2898, -87.0211, -118.1270, ...
             -73.1894, -116.2156, -117.7507, -82.3940, -82.8498, -84.2327, -121.7569, -119.4507, -98.1836, -119.6115, -112.3496, ...
             -74.0143, -115.5631, -71.0589, -77.4360, -80.2089, -77.4019, -118.1138, -79.4625, -97.4975, -97.9139, -74.4074, ...
             -90.8779, -74.265, -71.2883, -118.4053, -73.9661, -86.1182, -83.6523, -87.5295, -73.8633, -75.3552, -70.6690, -75.5831,  ...
              -74.9499, -71.5643, -74.5720, -73.0930, -74.1301, -71.1261, -71.0105, -72.7993, -76.1394, -71.5532,  ...
              72.6359, -75.3283, -74.1373, -70.9771, -74.4708, -70.9165, -74.2564, -75.0561, -87.968, -82.9274, -97.6207, ...
              -74.0705, -76.9893, -75.2154, -74.434, -74.9341, -73.7465, -88.1041, -80.118, -84.5715, -74.2131, ...
              -90.4937, -81.3395, -81.9055, -72.1848, -86.8, -75.398, -75.759, -74.4089, -74.6525, -83.0169, ...
              -89.8497, -75.3885, -70.7274, -72.0712, -74.3959, -74.1217, -74.592, -74.0595, -75.6381, -84.0589, ... 
              -72.8726, -75.33, -79.7775, -72.5172, -74.313, -75.2961, -75.4405, -92.8906, -72.928, -88.1072, ...
              -75.0305, -70.7796, -75.5742, -75.3326, -74.1392, -74.5505, -74.2979, -80.0406, -87.8831, -75.6844, ... 
              -72.6335, -71.3215, -71.367, -75.2973, -75.992, -73.3579, -75.4264, -74.3072, -81.835, -74.9779, ...
              -75.4107, -74.2721, -90.3924, -80.6125, -75.6309, -71.6179, -83.6519, -74.5373, -75.2581, -73.494, ...
              -86.7226, -96.5992, -71.4964, -76.2338, -71.5376, -117.8103, -118.0379, -118.0817, -78.1762, -96.8961, ...
              -122.3661, -87.6307, -86.8086, -122.2986, -72.2276, -74.1849, -98.5706, -105.0747, -94.1288, -82.6379, ... 
              -122.1341, -121.0769, -122.6394, -90.1320, -77.2811, -117.7678, -81.5292, -87.0611, -104.9811, -122.4016, ...
              -105.0167, -93.9963, -122.4869, -86.0341, -89.6301, -105.5022, -118.0120, -105.0372, -74.6054, -117.8265, ... 
              -91.3923, -82.0105, -84.2696, -76.1956, -98.4865, -97.0856, -73.6440, -118.8820, -81.5146, -111.9261, ...
              -79.2353, -71.4676, -122.2087, -97.1431, -72.6506, -81.7948, -86.2911, -122.7715, -79.8661, -86.8753, ...
              -74.4277, 76.4280, -89.8174, -95.9808, -77.4293, -88.8279, -74.4838, -75.9960, -85.8203, -92.4453, ...
              -92.5868, -71.3701, -96.8903, -92.1735, -74.0104, -80.1289, -119.0376, -86.2478, -75.9108, -123.0351, ...
              -97.3973, -79.7626, -81.6057, -98.0298, -117.8067, -83.1776, -96.1089, -70.3002, -81.4457, -89.7812, -109.2023, ...
              -75.3026, -73.0887, -71.2768, -74.4977, -80.4089, -71.7598, -80.7651, -86.4597, -87.7145, -83.3309, -95.4304, -74.2203, -83.3760,  ...
               -79.0717, -97.7935, -91.2960, -81.5612, -93.4023, -75.4552, -104.8202, -117.1889,  -97.0320, -118.0648, -118.3885, -77.1957, -117.0204, -74.2049, -97.1081, -86.9271,  ...
               -68.7778, -84.8733, -73.7101, -114.3225, -118.3406, -81.0280, -73.2121, -117.8605, -86.5200, -116.3743, -76.5100, -71.5375,  -82.5618, -117.5600, -97.8784, -95.2353,  ...
               -81.0369, -75.0849, -96.6107, -78.8986, -118.0513, -74.8726, -84.5613, -76.1805,  -119.7029, -82.7883, -95.6006, -81.0124,  ...
               -81.3590, -80.2494, -74.6155, -122.8756,  -73.7562, -85.9206, -78.8867, -85.7873, -90.2411, -82.3248, -77.7075, -104.8214, -93.6207, -71.1555, ...
            -78.1547, -85.1394, -116.9990, -75.5647, -115.1530, -104.9916, -76.3057, -119.1373, -91.2396, -85.4808, -73.8371, -97.6549, -80.3977, -97.6772, -80.3039, -79.7626, -122.0296, -122.3183, -101.8313, -122.6750, -80.2060, -74.0249, -123.2020, -69.6311, -87.5711, -121.8863, -81.8406, -120.8460, ...
            -84.5037, -83.8883, -74.0134, -112.0740, -80.0890, -75.5997, -111.8907, -96.6343, -120.9577, -117.3755, -103.8965, -81.4076, -72.7794, -79.3950, -73.9715, -111.6513, -76.5861, -95.4561, -94.5786, -119.0187, -122.6615, -111.5497, -122.4443, -92.6623, -122.3321, -97.3964, -83.9207, -117.1805, -118.1338, -96.4680, -119.2921, -117.0853, -96.3965, -88.6092, -77.4603, ...
            -81.9498, -124.0824, -85.6602, -122.0383, -85.3800, -96.3690, -84.7389, -80.6347, -95.3697, -70.9342, -96.6398, -87.2884, -82.9988, -90.7196, ...
            -99.2952, -117.9382, -90.0552, -118.3137, -105.0372, -84.5499, -96.7970, -116.9587, -92.0032, -122.2727, -80.2130, -98.2300, -90.1850, -81.0348, -117.2287, -118.1542, -118.2201, -81.6247, -77.9147, -97.9414, -89.8505, -117.6889, -90.1848, -118.0817, -122.6858, -120.4357, -121.4944, -81.9320, -119.3492, -94.7977, -90.0011, -75.8228, -91.1871, -95.2090, -118.0857, ...
            -88.8190, -88.5375, -109.5453, -97.4975, -93.9397, -81.3792, -90.1783, -77.9975, -95.3580, -93.7502, -92.6413, -96.8679, -80.0314, -76.1474, -87.8172, -81.5331, -83.2785, -96.8899, -80.0680, -74.0324, -83.9778, -82.6460, -81.5235, -80.1248, -96.2702, -121.5302, -77.0369, -88.7032, -76.5019, -81.3030, -122.5231, -108.7426, -92.3740, -75.1652, -71.3829, ...
            -115.5335, -71.4222, -74.2107, -121.6555, -118.2191, -74.5539, -75.2330, -80.1816, -118.1950, -98.0757, -84.4568, -66.1057, -77.6088, -81.4910, -81.8723, -97.6317, -117.9496, -119.0305, -118.1490]; 

% Combine into a table
T = table(communityname', compositeIndex', latitude', longitude', 'VariableNames', {'CommunityName', 'CompositeIndex', 'Latitude', 'Longitude'});

% Display the table
disp(T);

length(communityname)
length(compositeIndex)
length(latitude)
length(longitude)

% Create a figure and map axes
figure;
ax = axesm('lambert', 'MapLatLimit', [24 50], 'MapLonLimit', [-125 -65]);
setm(ax, 'Frame', 'on', 'Grid', 'on', 'MeridianLabel', 'on', 'ParallelLabel', 'on');
axis off; % Turn off the default axes

% Display the USA map
geoshow(ax, states, 'FaceColor', [0.8 0.8 0.8]); % State boundaries with gray face color

colors = hot(256); % Use 'hot' colormap
colorIndices = round(compositeIndex * (size(colors, 1) - 1)) + 1;

% Plot cities with color-coded intensity
hold on;
for i = 1:length(latitude)
    scatterm(latitude(i), longitude(i), 50, colors(colorIndices(i), :), 'filled', 'DisplayName', communityname{i});
end

% Add a colorbar
colormap(colors);
colorbar;
caxis([min(compositeIndex), max(compositeIndex)]);
title('Composite Index Intensity Across US Cities');
legend show; % Display city names as legend